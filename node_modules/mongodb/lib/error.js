'use strict';

<<<<<<< HEAD
const MongoNetworkError = require('./core').MongoNetworkError;
const mongoErrorContextSymbol = require('./core').mongoErrorContextSymbol;
=======
const MongoNetworkError = require('mongodb-core').MongoNetworkError;
const mongoErrorContextSymbol = require('mongodb-core').mongoErrorContextSymbol;
>>>>>>> e547b3e77583be3c8de92b6c78317e2fb285a75a

const GET_MORE_NON_RESUMABLE_CODES = new Set([
  136, // CappedPositionLost
  237, // CursorKilled
  11601 // Interrupted
]);

<<<<<<< HEAD
// From spec@https://github.com/mongodb/specifications/blob/7a2e93d85935ee4b1046a8d2ad3514c657dc74fa/source/change-streams/change-streams.rst#resumable-error:
//
// An error is considered resumable if it meets any of the following criteria:
// - any error encountered which is not a server error (e.g. a timeout error or network error)
// - any server error response from a getMore command excluding those containing the error label
//   NonRetryableChangeStreamError and those containing the following error codes:
//   - Interrupted: 11601
//   - CappedPositionLost: 136
//   - CursorKilled: 237
=======
// From spec@https://github.com/mongodb/specifications/blob/35e466ddf25059cb30e4113de71cdebd3754657f/source/change-streams.rst#resumable-error:
//
// An error is considered resumable if it meets any of the following criteria:
// - any error encountered which is not a server error (e.g. a timeout error or network error)
// - any server error response from a getMore command excluding those containing the following error codes
//   - Interrupted: 11601
//   - CappedPositionLost: 136
//   - CursorKilled: 237
// - a server error response with an error message containing the substring "not master" or "node is recovering"
>>>>>>> e547b3e77583be3c8de92b6c78317e2fb285a75a
//
// An error on an aggregate command is not a resumable error. Only errors on a getMore command may be considered resumable errors.

function isGetMoreError(error) {
  if (error[mongoErrorContextSymbol]) {
    return error[mongoErrorContextSymbol].isGetMore;
  }
}

function isResumableError(error) {
  if (!isGetMoreError(error)) {
    return false;
  }

<<<<<<< HEAD
  if (error instanceof MongoNetworkError) {
    return true;
  }

  return !(
    GET_MORE_NON_RESUMABLE_CODES.has(error.code) ||
    error.hasErrorLabel('NonRetryableChangeStreamError')
=======
  return !!(
    error instanceof MongoNetworkError ||
    !GET_MORE_NON_RESUMABLE_CODES.has(error.code) ||
    error.message.match(/not master/) ||
    error.message.match(/node is recovering/)
>>>>>>> e547b3e77583be3c8de92b6c78317e2fb285a75a
  );
}

module.exports = { GET_MORE_NON_RESUMABLE_CODES, isResumableError };
